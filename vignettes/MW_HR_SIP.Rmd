---
title: "MW-HR-SIP"
author: "Nick Youngblut"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction

## HR-SIP method basics:

* Remove sparsely occuring OTUs under the assumption that they are sequencing errors.
    * This is assuming that an OTU should at least be seen in a set number of fractions from the same gradient, since it's DNA should be (approximately) normally distributed. 
* Subset the dataset into treatment + corresponding control comparisions.
    * For instance, all fractions from a 13C-cellulose gradient versus all fractions from a 12C-cellulose gradient. 
* For each OTU, use DESeq2 to detect significant enrichment of in 'heavy' gradient fractions.
    * 'heavy' gradients are selected *ad hoc*
    * Multiple hypotheses are adjusted for. 
    * Significantly enriched OTUs are considered to have incorporated isotope (incorporators)

## MW-HR-SIP method basics:

* The method is similar to HR-SIP, except instead of 1 'heavy' BD window used, multiple windows are used, but the tradeoff is the higher number of multiple hypotheses that must be corrected for. 
* This method has been shown to be generally more sensitive (more true positives) than HR-SIP and more specific (less false positives) than q-SIP. See the manuscript "Multiple window High Resolution Stable Isotope Probing (MW-HR-SIP)" for more information. 

# Dataset 

First, let's load some packages including \code{HTSSIP}. 

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(doParallel)
library(HTSSIP)
```

Also, let's look at the phyloseq object that we will be using for this example. 

```{r, message=FALSE, warning=FALSE}
physeq
```


# HR-SIP

Let's set some parameters

```{r}
# adjusted P-value cutoff 
padj_cutoff = 0.1
# number of cores for parallel processing
ncores = 8
```

## Parsing the dataset

The first step is to subset the dataset so that we can compare each 13C-treatment to its corresponding 12C-control. For this dataset, the comparisons are simple:

* 13C-glucose vs 12C-control 
* 13C-cellulose vs 12C-control

Note that the same 12C-control is used for both because both treatments recieved both glucose & cellulose, but only 1 substrate was isotopically labeled.

So to subset the data with phyloseq, we can use the \code{prune_samples()} function to subset the dataset:

```{r}
physeq_13C_glu = "(Substrate=='12C-Con') | (Substrate=='${Substrate}')"
```


```{r}
ex = "(Substrate=='12C-Con' & Day=='${Day}') | (Substrate=='${Substrate}' & Day == '${Day}')"
```


```{r}
params = get_treatment_params(physeq, c('Substrate', 'Day'), "Substrate != '12C-Con'")
params

```



```{r, message=FALSE}
df_l2fc = HRSIP(physeq,
                pairwise_expr=ex,
                pairwise_params=params,
                sparsity_threshold=c(0, 0.1),
                density_windows=c(1.71, 1.75),
                design=~Substrate)
df_l2fc %>% head(n=3)
```

Number of incorporators per substrate

```{r}
df_l2fc %>% 
  filter(padj < padj_cutoff) %>%
  group_by(Substrate) %>%
  summarize(n_incorp_OTUs = OTU %>% unique %>% length)
```

Breakdown of incorporators for each substrate. 

```{r, fig.width=7, fig.height=4}
# summarizing
df_l2fc_s = df_l2fc %>% 
  filter(padj < padj_cutoff) %>%
  mutate(Rank2 = gsub('^__', '', Rank2)) %>%
  group_by(Substrate, Rank2) %>%
  summarize(n_incorp_OTUs = OTU %>% unique %>% length) %>%
  ungroup()

# plotting
ggplot(df_l2fc_s, aes(Rank2, n_incorp_OTUs)) +
    geom_bar(stat='identity') +
    labs(x='Phylum', y='Number of incorporators') +
    theme_bw() +
    theme(
      axis.text.x = element_text(angle=45, hjust=1)
    )
```


# MW-HR-SIP

Same as above. 

```{r}
params = get_treatment_params(physeq, c('Substrate', 'Day'), "Substrate != '12C-Con'")
ex = "(Substrate=='12C-Con' & Day=='${Day}') | (Substrate=='${Substrate}' & Day == '${Day}')"
```

Now using 3 buoyant density windows: (1.70-1.73, 1.72-1.75, 1.74-1.77)

```{r}
windows = data.frame(start=c(1.70, 1.72, 1.74), end=c(1.73, 1.75, 1.77))
windows
```

Running HRSIP with all 3 BD windows. Let's run this in parallel to speed things up.
You can turn off parallel processing by setting the \code{parallel} option to \code{FALSE}.

```{r, message=FALSE}

registerDoParallel(ncores)

df_l2fc = HRSIP(physeq,
                pairwise_expr=ex,
                pairwise_params=params,
                sparsity_threshold=c(0, 0.1),
                density_windows=windows,
                design=~Substrate,
                parallel=TRUE)
df_l2fc %>% head(n=3)
```


Number of incorporators per substrate. 

```{r}
df_l2fc %>% 
  filter(padj < padj_cutoff) %>%
  group_by(Substrate) %>%
  summarize(n_incorp_OTUs = OTU %>% unique %>% length)
```

Note that the MW-HR-SIP method identifies more incorporators than the HR-SIP method (which uses just one BD window). This is especially true for 13C-glucose. 

MW-HR-SIP detects more taxa because taxa vary in G+C content, so using only 1 BD window likely encompasses BD shifts for taxa of certain G+C contents (eg., ~50% G+C), but may miss other taxa with higher or lower G+C content. 

Okay. Let's plot the number of incorporators for each labeled substrate. 

```{r, fig.width=7, fig.height=4}
# summarizing
df_l2fc_s = df_l2fc %>% 
  filter(padj < padj_cutoff) %>%
  mutate(Rank2 = gsub('^__', '', Rank2)) %>%
  group_by(Substrate, Rank2) %>%
  summarize(n_incorp_OTUs = OTU %>% unique %>% length) %>%
  ungroup()

# plotting
ggplot(df_l2fc_s, aes(Rank2, n_incorp_OTUs)) +
    geom_bar(stat='identity') +
    labs(x='Phylum', y='Number of incorporators') +
    theme_bw() +
    theme(
      axis.text.x = element_text(angle=45, hjust=1)
    )
```

MW-HR-SIP detected incorporators in phyla not seen with HR-SIP (eg., Acidobacteria). 


# Session info

```{r}
sessionInfo()
```

